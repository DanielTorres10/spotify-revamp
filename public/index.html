<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Spotify Revamped</title>
    <link href="styles.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <div id="login">
      <h1>Spotify Test Page</h1>
      <button id='login-btn' ><a href="/login">Log in with Spotify</a></button>
    </div>

    <script src="https://code.jquery.com/jquery-git2.js"></script>
    <script>
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }
       // Get user info
        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;
        
      function find(){
        console.log('enetred find()');
        var searchType = $('#search-form').serializeArray()[0].value;
        var searchTerm = $('#search-form').serializeArray()[1].value;
        console.log('searched for: ' + searchType + ', ' + searchTerm);
        $('#search-results').html('<p><strong>'+searchType[0].toUpperCase()
          +searchType.slice(1)+ ' results for </strong>'+searchTerm)+'</p>';
        console.log('1 we out here');
        if (error) {
          alert('There was an error during the search process');
        } else if(access_token) {

          console.log('2 we in here');
          $.ajax({
              url: 'https://api.spotify.com/v1/search?q='+searchTerm+'&type='+searchType+'&limit=6&offset=0',
              type: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + access_token
              },
              success: function(response) { 
                  console.log('3 we in here'); 
                  console.log(response)
                  var items;
                  eval("items = response."+searchType+"s.items;");
                  for(var i=0; i<items.length; i++) {
                    displayIndividualResults(items, i, searchType);
                  }
              }
          });

          function displayIndividualResults(items, i, type){
            console.log('4 we in here');
            var result = "<div class='result-item'>";
            var name = ("<a href='" + items[i].external_urls.spotify + "' target='_blank'>"
                + "<h3>"+items[i].name+"</h3></a>");
            var image, artists, owners;
            if (type === "album") {
              image = ("<a class='result-img' href='" + items[i].external_urls.spotify + "' target='_blank'>"
                + "<img id='pl-img' src=" + img + " alt='No image available'></a>");
              
              artists = "<h5>"
              items[i].artists.forEach(function(artist, index){
                artists += "<a href='"+artist.external_urls.spotify+"' target='_blank'>"+artist.name+"</a>, ";
                //if (index > 4) {result += ...; break;}
                });
              //Remove last comma
              artists = artists.substr(0, artists.length-2);
              artists += "</h5>";
              owners = "";
            } else if (type === "artist") {
              var img;
              if (items[i].images[0]) {
                img = items[i].images[0].url
              } else {
                img = "./noImage.png"
              }
              image = ("<a class='result-img' href='" + items[i].external_urls.spotify + "' target='_blank'>"
                + "<img src=" + img + " alt='No image available'></a>");
              
              artists = "";
              owners = "";
            } else if (type === "track") {
              console.log('entered track search');
              var img;
              if (items[i].album.images[0]) {
                img = items[i].album.images[0].url
              } else {
                img = "./noImage.png"
              }
              console.log('img set');
              image = ("<a class='result-img' href='" + items[i].external_urls.spotify + "' target='_blank'>"
                + "<img src=" + img + " alt='No image available'></a>");
              
              artists = "<h5>"
              items[i].artists.forEach(function(artist, index){
                artists += "<a href='"+artist.external_urls.spotify+"' target='_blank'>"+artist.name+"</a>, ";
                //if (index > 4) {result += ...; break;}
                });
              //Remove last comma
              artists = artists.substr(0, artists.length-2);
              artists += "</h5>";
              owners = "";
            } else if (type === "playlist") {
              var img;
              if (items[i].images[0]) {
                img = items[i].images[0].url
              } else {
                img = "./noImage.png"
              }
              image = ("<a class='result-img' href='" + items[i].external_urls.spotify + "' target='_blank'>"
                + "<img src=" + img + " alt='No image available'></a>");
              
              artists = "";
              owners = "<a href='"+items[i].owner.external_urls.display_name+"' tarbet='_blank'>"+items[i].owner.display_name+"</a>";
            } else {
              console.log('5 type = ' + type);
            }
            // 
            result += image + name + owners + artists + "</div>";
            $('#search-results').append(result);
          }
        $('#loggedin').hide();
        }
      }
    </script>

    <div id="search-bar">
      <form id="search-form" method="dialog" target="_blank">
        <!-- <label for="search"> -->Search <!-- </label> -->
        <select name="type">
          <option value="album">albums</option>
          <option value="artist">artists</option>
          <option value="track" selected="selected">songs</option>
          <option value="playlist">playlists</option>
        </select>
        <input type="search" name="search">
        <input type="submit" value="Search" onclick="find()">
      </form>
    </div> 

    <!-- SEARCH RESULTS HERE-->
    <div id="search-results"></div>
    
    <!-- PROFILE PAGE HERE -->
     <div id="loggedin">
        <div id="showUser"></div>
        <h2> Top Songs </h2>
        <div id="showSongs" class="grid-container"></div>
        <h2> Top Artists </h2>
        <div id="showArtists" class="grid-container"></div>
        <h2> Your Playlists </h2>
        <div id="showPlaylists" class="grid-container"></div>
     </div>
    
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>

    <script>
      (function() {
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

       // Get user info
        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;
        
        if (error) {
          alert('There was an error during the authentication');
        } else if(params.access_token) {
           $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                outputToDiv(response, 0, "#showUser");
                }
            });
          // Get playlists 
          $.ajax({
                url: 'https://api.spotify.com/v1/me/playlists',
                type: 'GET',
                headers: {
                  'Authorization' : 'Bearer ' + access_token
                },
                contentType:"application/json",
                success: function(response) {   
                  var items = response.items;
                  for(var i=0; i<items.length; i++) {
                    outputToDiv(items, i, "#showPlaylists");
                  }
                }
          });

          // Get top tracks info
           $.ajax({
                url: 'https://api.spotify.com/v1/me/top/tracks?limit=5&offset=15',
                type: 'GET',
                headers: {
                  'Authorization' : 'Bearer ' + access_token
                },
                contentType:"application/json",
                success: function(response) {
                  var items = response.items;
                  for(var i=0; i<items.length; i++) {
                    outputToDiv(items, i, "#showSongs");
                  }
                }
            });
          // Get top artists info
           $.ajax({
                url: 'https://api.spotify.com/v1/me/top/artists',
                type: 'GET',
                headers: {
                  'Authorization' : 'Bearer ' + access_token
                },
                contentType:"application/json",
                success: function(response) {
                  $('#login').hide();
                  $('#loggedin').show();
                  var items = response.items;
                  for(var i=0; i<items.length; i++){
                    outputToDiv(items, i, "#showArtists");
                  }
                },
            });

         function outputToDiv(items,i,id) {
          // Edit User Profile Design Here!!!!
          if(id==="#showUser") {
            if(items.images[0]) {
            $(id).append(                
               "<div id='prof-container'>" +
                 "<img src=" + items.images[0].url + ">" +
                 "<div id='prof-text'>" +
                   "<h2> User </h2>" +
                   "<h1>" + items.display_name + "</h1>" +
                 "</div>" +
               "</div>"
              );
            // User with no profile image
            } else {
            $(id).append(                
               "<div id='prof-container'>" +
                "<h2> No profile image </h2>" +
                 "<div id='prof-text'>" +
                   "<h2> User </h2>" +
                   "<h1>" + items.display_name + "</h1>" +
                 "</div>" +
               "</div>"
              );
            }
          // Edit Top Songs Design Here!!!!
          } else if(id==="#showSongs") {  
            if(items[i].album.images[0]) {               
            $(id).append(                
                "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + " target='_blank'> <img id='pl-img' src=" + items[i].album.images[0].url + "> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                "</div>"
                );
            // No album image
            } else {
            $(id).append(                
                "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <h2> No album image </h2> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                "</div>"
                );
            }
          // Edit Top Artists Design Here!!!!
          } else if (id==="#showArtists"){
            if(items[i].images[0]) {
            $(id).append(                
                "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <img id='pl-img' src=" + items[i].images[0].url + "> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                "</div>"
                );
            } else {
            $(id).append(                
                "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <h2> No album image </h2> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                "</div>"
                );
            }
          // Edit Playlists Design Here!!!!   
          } else {
           if(items[i].images[0]) {
           $(id).append(                
                "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <img id='pl-img' src=" + items[i].images[0].url + "> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                "</div>"
                ); 
           // No playlist cover image
           } else {
           $(id).append(                
                "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <h2> No playlist image </h2> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                "</div>"
                ); 
           }      
          }
        }
      } else {
        // render initial screen
        $('#login').show();
        $('#loggedin').hide();
        $('#search-bar').hide();
        $('#search-results').hide();
        }
      })();
    </script>
  </body>
</html>