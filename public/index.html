<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Spotify Revamped</title>
    <link href="styles.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <div id="login">
      <h1>Spotify Test Page</h1>
      <button id='login-btn' ><a href="/login">Log in with Spotify</a></button>
    </div>
    <!-- PROFILE PAGE HERE -->
     <div id="loggedin">
        <div id="showUser"></div>
        <div id="player"></div>
        <button id='btn-prev' >Previous</button>
        <button id='btn-play' >Play</button>
        <button id='btn-pause' >Pause</button>
        <button id='btn-next' >Next</button>
        <h2> Top Songs </h2>
        <div id="showSongs" class="grid-container"></div>
        <h2> Top Artists </h2>
        <div id="showArtists" class="grid-container"></div>
        <h2> Top Albums </h2>
        <div id="showAlbums" class="grid-container"></div>
        <h2> Your Playlists </h2>
        <div id="showPlaylists" class="grid-container"></div>
     </div>
     
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <script>
      (function() {
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
            hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

       // Get user info
        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

        var map = new Map();
        var albumInfo = new Set();
        
        if (error) {
          alert('There was an error during the authentication');
        } else if(params.access_token) {
           $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                outputToDiv(response, 0, "#showUser");
                  // Get playlists 
                  $.ajax({
                       url: 'https://api.spotify.com/v1/users/'+ response.id +'/playlists',
                       type: 'GET',
                       headers: {
                         'Authorization' : 'Bearer ' + access_token
                       },
                       contentType:"application/json",
                       success: function(response) {   
                         var items = response.items;
                         for(var i=0; i<items.length; i++) {
                           outputToDiv(items, i, "#showPlaylists");
                         }
                       }
                  });
                }
            });

          // Get top tracks info
           $.ajax({
                url: 'https://api.spotify.com/v1/me/top/tracks',
                type: 'GET',
                headers: {
                  'Authorization' : 'Bearer ' + access_token
                },
                contentType:"application/json",
                success: function(response) {
                  var items = response.items;
                  for(var i=0; i<items.length; i++) {
                    outputToDiv(items, i, "#showSongs");
                  }
                 // Get top albums
                 map =  findTopAlbums(map, items);
                 for(var i=0; i<map.length; i++) {
                     outputToDiv(map[i], 0, "#showAlbums");
                 }
                }
            });
          // Get top artists info
           $.ajax({
                url: 'https://api.spotify.com/v1/me/top/artists',
                type: 'GET',
                headers: {
                  'Authorization' : 'Bearer ' + access_token
                },
                contentType:"application/json",
                success: function(response) {
                  $('#login').hide();
                  $('#loggedin').show();
                  
                  var items = response.items;
                  for(var i=0; i<items.length; i++) {
                    outputToDiv(items, i, "#showArtists");
                  }
                },
            });
          
         controlWebPlayer(access_token, "",false);
         // Getting Spotify player 
         getPlayer(access_token);

         function getPlayer(t) {
           window.onSpotifyWebPlaybackSDKReady = () => {
             const token = t;
             const player = new Spotify.Player({
             name: 'Web Playback SDK Quick Start Player',
               getOAuthToken: cb => { cb(token); }
             });

             // Error handling
             player.addListener('initialization_error', ({ message }) => { console.error(message); });
             player.addListener('authentication_error', ({ message }) => { console.error(message); });
             player.addListener('account_error', ({ message }) => { console.error(message); });
             player.addListener('playback_error', ({ message }) => { console.error(message); });

             var dID;
             // Ready
             player.addListener('ready', ({ device_id }) => {
               console.log('Ready with Device ID', device_id);
               dID = device_id;
             });

             // Not Ready
             player.addListener('not_ready', ({ device_id }) => {
               console.log('Device ID has gone offline', device_id);
             });

             // Playback status updates
             player.addListener('player_state_changed', state => { 
               console.log(state); 
               controlWebPlayer(access_token, "", false);
             });
             // Connect to the player!
             player.connect();
           };
         }
         function controlWebPlayer(token, deviceName, web) {
           var dev_id;
            // Get current device playing Spotify
            $.ajax({
                url: 'https://api.spotify.com/v1/me/player',
                type: 'GET',
                headers: {
                  'Authorization' : 'Bearer ' + token
                },
                contentType:"application/json",
                success: function(response) {
                    dev_id = response.device.id;
                    $('#player').html(                  
                     "<img id='pl-img' src=" + response.item.album.images[0].url + ">" +
                     "<p> Currently Playing: " +  response.item.name + 
                     " on " + response.device.name + "</p>"
                  );
                 },
            });

            // next track
            document.getElementById('btn-next').onclick = function() {
              $.ajax({
                url: 'https://api.spotify.com/v1/me/player/next',
                type: 'POST',
                headers: {
                  'Authorization' : 'Bearer ' + token
                },
                contentType:"application/json",
               });
            }

            // prev track
            document.getElementById('btn-prev').onclick = function() {
              $.ajax({
                url: 'https://api.spotify.com/v1/me/player/previous',
                type: 'POST',
                headers: {
                  'Authorization' : 'Bearer ' + token
                },
                contentType:"application/json",
               });
            }

            // play track
            document.getElementById('btn-play').onclick = function() {
              $.ajax({
                url: 'https://api.spotify.com/v1/me/player/play',
                type: 'PUT',
                headers: {
                  'Authorization' : 'Bearer ' + token
                },
                contentType:"application/json",
               });
            }

            // pause track
            document.getElementById('btn-pause').onclick = function() {
              $.ajax({
                url: 'https://api.spotify.com/v1/me/player/pause',
                type: 'PUT',
                headers: {
                  'Authorization' : 'Bearer ' + token
                },
                contentType:"application/json",
               });
            }
         }
 
         function findTopAlbums(map, items) { 
            var name; 
           for(var i=0; i< items.length; i++) { 
              name = items[i].album.name;  
             if(!map.has(name)) {
               map.set(name, 1);
             } else if(map.has(name)) {
                map.set(name, map.get(name)+1);
             } 
           }
           // deleting albums in which only one song was heard
           for(var i=0; i< items.length; i++) { 
             name = items[i].album.name;  
             if(map.get(name)===1) {
               map.delete(name);
             } 
           }
           // getting album info
           for(var i=0; i< items.length; i++) { 
             if(map.has(items[i].album.name)) {
               map.set(items[i].album, map.get(items[i].album.name));
               map.delete(items[i].album.name);
             }  
           }
           // sorting map
           map[Symbol.iterator] = function* () {
             yield* [...this.entries()].sort((a, b) => b[1] - a[1]);
           }
              return [...map];            
         }
        


         function outputToDiv(items,i,id) {
          // Edit User Profile Design Here!!!!
          if(id==="#showUser") {
            if(items.images[0]) {
            $(id).append(                
               "<div id='prof-container'>" +
                 "<img src=" + items.images[0].url + ">" +
                 "<div id='prof-text'>" +
                   "<h2> User </h2>" +
                   "<h1>" + items.display_name + "</h1>" +
                 "</div>" +
               "</div>"
              );
            // User with no profile image
            } else {
            $(id).append(                
               "<div id='prof-container'>" +
                "<h2> No profile image </h2>" +
                 "<div id='prof-text'>" +
                   "<h2> User </h2>" +
                   "<h1>" + items.display_name + "</h1>" +
                 "</div>" +
               "</div>"
              );
            }
          // Edit Top Songs Design Here!!!!
          } else if(id==="#showSongs") {  
              if(items[i].album.images[0]) {           
                $(id).append(                
                  "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <img id='pl-img' src=" + items[i].album.images[0].url + "> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                  "</div>"
                );

              // No album image
              } else {
                $(id).append(                
                  "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <h2> No album image </h2> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                  "</div>"
                );
            }
          // Edit Top Albums Design Here!!!!
          } else if(id==="#showAlbums") {  
              if(items[i].images[0]) {           
                $(id).append(                
                  "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <img id='pl-img' src=" + items[i].images[0].url + "> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                  "</div>"
                );

              // No album image
              } else {
                $(id).append(                
                  "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <h2> No album image </h2> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                  "</div>"
                );
            }
          // Edit Top Artists Design Here!!!!
          } else if (id==="#showArtists") {
            if(items[i].images[0]) {
            $(id).append(                
                "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <img id='pl-img' src=" + items[i].images[0].url + "> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                "</div>"
                );
            } else {
            $(id).append(                
                "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <h2> No album image </h2> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                "</div>"
                );
            }
          // Edit Playlists Design Here!!!!   
          } else {
           if(items[i].images[0]) {
           $(id).append(                
                "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <img id='pl-img' src=" + items[i].images[0].url + "> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                "</div>"
                ); 
           // No playlist cover image
           } else {
           $(id).append(                
                "<div class='grid-item'>" +
                  "<a href=" + items[i].uri + "> <h2> No playlist image </h2> </a>" +
                  "<h3>" + items[i].name + "</h3>" +
                "</div>"
                ); 
           }      
          }
        }
      } else {
        // render initial screen
        $('#login').show();
        $('#loggedin').hide();
        }
      })();
    </script>

  </body>
</html>